<html>
<head>
<link rel="stylesheet" type="text/css" href="theme.css">
</head>
<body>

<audio id="music" type="audio/mp3" src="background1.mp3" autoplay>
</audio>
<audio id="footstep" type="audio/mp3" src="footstepFloor.mp3">
</audio>
<div style="float:left;">
<canvas id="myCanvas" onclick="myCanvas()" width="1280" height="720"
style="border:1px solid #000000;">
Your browser does not support the HTML5 canvas tag.
</canvas>
<p>
Controls:<br>
Move with arrow keys.<br>
Interact with Ctrl.<br>
Find objects with mouse click.
</p>
</div>
<div style="margin-left:10cm;">
Objectives:<br>
<div id="objective">
Get out of the classroom.<br>
</div><br>
Subjective:<br>
<div id="subjective">
</div>
</div>

<script>
var canvas = document.getElementById('myCanvas'),
context = canvas.getContext('2d');

posX = 720;
posY = 360;
cutPosX = 0;
cutWidthX = 200;
cutPosY = 0;
var charReset;
var door = 0;
var locationEvent = 'classroom';
var moving = 0;
var units = 0;
var caseNumber = 0;
var roam = 1;
var battle = 0;
var transitionIntro = 0;
var transitionIntroX = -1280;
var transitionOutro = 0;
var transitionOutroX = -1280;
var footstep = document.getElementById('footstep');
var music = document.getElementById('music');
var subjective = document.getElementById("subjective");
var objective = document.getElementById("objective");
var moveSidePos = 0;
var movePos = 0;
var trackNumber = 1;
var whiteboardText;
var randomText;
var randomMessages = Array("BIP BIP BUB","~You can't touch this. DAA-DA-DA-DA~","PC shows BCoD. RIP PC.","Your PC got a virus. Good Job!","FORMAT C:");
var timeRandomText;

//Battle info
var playerHealth = 100;
var yourTurn = 1;
var showHealthBars;
var opponentHealth;
var myHealth;
var beginBattle;
var endBattle;
var gooAttack;
var combatUnits;
var gooPosX = 250;
var gooPosY = 250;
var doOpponentAttack;
var opponentAttackPosX = 650;
var opponentAttackPosY = 200;
var opponentTimeout;

base_image = new Image();
base_image.src = 'sprite.png';

whity = new Image();
whity.src = 'white.png';

gooImage = new Image();
gooImage.src = '../Weapons/snotter_fly.png';

opponentAttackImage = new Image();
opponentAttackImage.src = 'Caution.png';

background = new Image();
background.src = '../Level Design/ClassRoom.png';

transitionIntroImage = new Image();
transitionIntroImage.src = 'transitionIntroImage.gif';

transitionOutroImage = new Image();
transitionOutroImage.src = 'transitionOutroImage.gif';

npc1 = new Image();
var npc1PosX;
var npc1PosY;
var npc1SizeX;
var npc1SizeY;

npc2 = new Image();
var npc2PosX;
var npc2PosY;
var npc2SizeX;
var npc2SizeY;

battleChar1 = new Image();
var battleChar1PosX;
var battleChar1PosY;
var battleChar1SizeX;
var battleChar1SizeY;
var battleChar1cutPosX;
var battleChar1cutWidthX;
var battleChar1cutPosY;

battleChar2 = new Image();
var battleChar2PosX;
var battleChar2PosY;
var battleChar2SizeX;
var battleChar2SizeY;

music.volume = 0.0; // VOLUME 0.1

document.addEventListener('keydown', updateMovement);
canvas.addEventListener('mousedown', mouseClick);
music.addEventListener('ended', switchTrack);
window.addEventListener('load', render);
var FPS = 30;
var now;
var then = Date.now();
var interval = 1000/FPS;
var delta;
//setInterval(function() {
//function render(){

//  update();
//  draw();
//  window.requestAnimationFrame(render);
//  }
//}, 1000/FPS);

function render() {
     
    requestAnimationFrame(render);
     
    now = Date.now();
    delta = now - then;
     
    if (delta > interval) {
        // update time stuffs
         
        // Just `then = now` is not enough.
        // Lets say we set fps at 10 which means
        // each frame must take 100ms
        // Now frame executes in 16ms (60fps) so
        // the loop iterates 7 times (16*7 = 112ms) until
        // delta > interval === true
        // Eventually this lowers down the FPS as
        // 112*10 = 1120ms (NOT 1000ms).
        // So we have to get rid of that extra 12ms
        // by subtracting delta (112) % interval (100).
        // Hope that makes sense.
         
        then = now - (delta % interval);
        update();
		draw();
        // ... Code for Drawing the Frame ...
    }
}

function update()
{
	if(!roam && !battle)
	{
		if(beginBattle)
		{
			transitionIntro = 1;
		}
		
		if(endBattle)
		{
			transitionOutro = 1;
		}
		
		if(!transitionIntroX && locationEvent == "hallway" && beginBattle)
		{
			startBattle("hallway_fight.png",'cleaning_lady.gif',50);
		}
		if(!transitionOutroX && locationEvent == "hallway" && endBattle)
		{
			//startBattle("hallway_fight.png",'cleaning_lady.gif',50);
			transitionOutro = 0;
			transitionOutroX = -1280;
			background.src = "../Level Design/"+locationEvent+".png";
			roam = 1;
			units = 60;
			endBattle = 0;
			combatUnits = 0;
		}
	}
	
	//In battle
	if(!roam && battle)
	{
		if(opponentHealth <= 0 && combatUnits <= 0)
		{
			endBattle = 1;
			beginBattle = 0;
		}
		
		//Set chars in position.
		if(units)
		{
			//console.log(battleChar1PosX);
			units = units - 1.5;
			battleChar1PosX = battleChar1PosX + 8;
			battleChar2PosX = battleChar2PosX - 8;
			if(units == 1.5)
			{
				yourTurn = 1;
			}
		}
		
		if((opponentHealth <=0) && endBattle)
		{
			setTimeout(returnFromBattle(),5000);
		}
	}
	updateAnimation(caseNumber);
	
}

function returnFromBattle()
{
	battle = 0;
	battleChar1 = new Image();
	battleChar2 = new Image();
	beginBattle = 0;
	endBattle = 1;
	caseNumber = 200;
	moving = 1;
	units = 30;
	switchTrack();
	doOpponentAttack = 0;
	gooAttack = 0;
	alertBox('Cleaning lady yells: "ARHH NOW I DO ALL CLEAN. ;("');
}

function mouseClick(event)
{
	canvasX = event.pageX;
	canvasY = event.pageY;
	if(90<canvasX && canvasX < 146 && 10<canvasY && canvasY<110 && locationEvent == 'classroom')
	{
		// Find key in classroom event.
		alertBox('You found the key!'+canvasX+" "+canvasY);
		door = 1;
		npc2.src = '';
		subjective.innerText = "";
	}
}

function updateMovement(evt)
{
	if([37, 38, 39, 40].indexOf(evt.keyCode) > -1) {
        evt.preventDefault();
    }
// Flag to put variables back if we hit an edge of the board.
        var flag = 0;
		var restricted = 0;

        // Get where the char was before key process.
        oldCharX = posX;
        oldCharY = posY;

        switch (evt.keyCode) {

		  // Ctrl
        case 17:
		if(roam)
		{
			if(locationEvent == 'classroom')
			{
				if (posX == 0 && posY == 400)
				{
					// If at door, Fire event
					if(door == 1)
					{
						alertBox('You walked out the door using the key.');
						locationEvent = 'hallway';
						background.src = '../Level Design/'+locationEvent+'.png';
						posX = 1200;
						posY = 400;
						npc1.src = 'cleaning_lady.gif';
						npc1PosX = 640;
						npc1PosY = 360;
						npc1SizeX = 70;
						npc1SizeY = 105;
						subjective.innerText = "Talk to the friendly looking'ish cleaning lady.";
					}
					else
					{
						alertBox('You cant get out. The door is  locked. "HINT: Something sparkles"');
						subjective.innerText = "Find the key.";
						npc2.src = 'sparkles.gif';
						npc2PosX = 175;
						npc2PosY = 100;
						npc2SizeX = 20;
						npc2PosY = 10;
					}
				}

				if (400 <= posX && posX <= 720 && posY == 40)
				{
					whiteboardText = "Dickbutt";
				}
				  
				if(posX == 720 && posY == 360)
				{
					randomPCMessage();
				}
			}
			if(locationEvent == 'hallway')
			{
				if((posX == 640 && posY == 320) || (posX == 640 && posY == 400) || (posX == 560 && posY == 360) || (posX == 720 && posY == 360))
				{
					alertBox('Cleaning lady yells: "U DO CLEAN!, NOT ME!"');
					battleMusic();
					//music.src = 'Hopeku___Blue_brass.mp3';
					roam = 0;
					moving = 1;
					units = 30;
					caseNumber = 200;
					beginBattle = 1;
				}
			}
		}
		if(battle)
		{
			
		}
		  
		  
          break;
		
          // Left arrow.
        case 37:
		if(roam)
		{
			if(locationEvent == 'classroom')
			{
				//Restricted areas in classroom
			    if((posX-80 == 720 && posY == 200) || (posX-80 == 960 && posY == 320) || (posX-80 == 480 && posY == 400) || (posX == 0))
			    {
					flag = 1;
					restricted = 1;
				}
			}
			if(locationEvent == 'hallway')
			{
				//Restricted areas in hallway
			    if((posX-80 == 640 && posY == 360) || (posX == 0))
			    {
					flag = 1;
					restricted = 1;
				}
			}
		  if(!moving && !restricted)
		  {
		  moving = 1;
		  units = 80;
          caseNumber = 37;
		  }
		  
		}
		if(battle)
		{
			
		}
          break;
		  

          // Right arrow.
        case 39:
		if(roam)
		{
			if(locationEvent == 'classroom')
			{
				//Restricted areas in classroom
			    if((posX+80 == 480 && posY == 200) || (posX+80 == 720 && posY == 320) || (posX+80 == 240 && posY == 400) || (posX+80 == 1280))
			    {
					flag = 1;
					restricted = 1;
				}
			}
			if(locationEvent == 'hallway')
			{
				//Restricted areas in classroom
			    if((posX+80 == 640 && posY == 360) || (posX+80 == 1280))
			    {
					flag = 1;
					restricted = 1;
				}
			}
		  if(!moving && !restricted)
		  {
			moving = 1;
			units = 80;
			caseNumber = 39;
		  }
		}
          break;

          // Down arrow
        case 40:
		if(roam)
		{
			if(locationEvent == 'classroom')
			{
				//Restricted areas in classroom
			    if((480 <= posX && posX <= 720 && posY+40 == 200) || (720 <= posX && posX <= 960 && posY+40 == 320) || (240 <= posX && posX <= 480 && posY+40 == 400) || (posY == 600))
			    {
					flag = 1;
					restricted = 1;
				}
			}
			if(locationEvent == 'hallway')
			{
				//Restricted areas in classroom
			    if((posX == 640 && posY+40 == 360) || (posY == 600))
			    {
					flag = 1;
					restricted = 1;
				}
			}
		  if(!moving && !restricted)
		  {
			moving = 1;
			units = 80;
			caseNumber = 40;
		  }
		}
		if(battle)
		{
			
		}
          break;

          // Up arrow 
        case 38:
		if(roam)
		{
		if(locationEvent == 'classroom')
		{
			if((480 <= posX && posX <= 720 && posY-40 == 200) || (720 <= posX && posX <= 960 && posY-40 == 320) || (240 <= posX && posX <= 480 && posY-40 == 400) || (posY-40 < 40)) {
				flag = 1;
				restricted = 1;
			}
			
		}
		if(locationEvent == 'hallway')
		{	  
			  if((640 == posX && posY-40 == 360) || (posY-40 < 40)) {
				flag = 1;
				restricted = 1;
			  }
		}
		if(moving == 0 && restricted == 0)
		  {
			moving = 1;
			units = 80;
			caseNumber = 38;
		  }
		}
		if(battle && yourTurn)
		{
			yourTurn = 0;
			gooAttackMethod();
			moving = 1;
			combatUnits = 80;
			caseNumber = 38;
		}
		else {
			flag = 1;
			restricted = 1;
		}
          break;

        }

        // If flag is set, the ship did not move.
        // Put everything back the way it was.
        
		
		
      }

function updateAnimation(caseNumbers)
{
	var flag = 0;
	if(units == 80)
	{
		oldCharX = posX;
        oldCharY = posY;
	}
	
	if(units > 0 || combatUnits > 0)
	{
		//Left arrow
		if(caseNumbers == 37)
		{
			if(roam == 1)
			{
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(moveSidePos == 0){cutPosX = 2200;}
				if(moveSidePos == 1){cutPosX = 2400;}
				if(moveSidePos == 2){cutPosX = 2600;}
				if(moveSidePos == 3){cutPosX = 2400;}
				moveSidePos++;
				if(moveSidePos == 4)
				{moveSidePos = 0;}
				}
				units = units - 5;
				posX = posX - 5;
				
				if (posX < 0)
				{
					// If at edge, reset char position and set flag.
					posX = 0;
					flag = 1;
				}
				if(!(flag))
				{
				resetChar();
				}
			}
		}
		
		// Right arrow
		if(caseNumbers == 39)
		{
			if(roam == 1)
			{
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(moveSidePos == 0){cutPosX = 1400;}
				if(moveSidePos == 1){cutPosX = 1600;}
				if(moveSidePos == 2){cutPosX = 1800;}
				if(moveSidePos == 3){cutPosX = 1600;}
				moveSidePos++;
				if(moveSidePos == 4)
				{moveSidePos = 0;}
				}
				units = units - 5;
				posX = posX + 5;
				
				  if (posX > 1210) {
					// If at edge, reset char position and set flag.
					posX = 1170;
					flag = 1;
				  }
				  if(!(flag))
			  {
				resetChar();
			  }
			}  
		}
		
		//Down arrow
		if(caseNumbers == 40)
		{
			if(roam == 1)
			{
				units = units - 5;
				posY = posY + 2.5;
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(movePos == 0){cutPosX = 200;}
				if(movePos == 1){cutPosX = 400;}
				movePos++;
				if(movePos == 2)
				{movePos = 0;}
				}
			  if (posY > 615) {
				// If at edge, reset ship position and set flag.
				posY = 600;
				flag = 1;
			  }
			  if(!(flag))
			  {
				resetChar();
			  }
			}
		}
		
		//Up arrow
		if(caseNumbers == 38)
		{
			if(roam)
			{
				units = units - 5;
				posY = posY - 2.5;
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(movePos == 0){cutPosX = 800;}
				if(movePos == 1){cutPosX = 1000;}
				movePos++;
				if(movePos == 2)
				{movePos = 0;}
				}
			  if (posY < 0) {
				// If at edge, reset ship position and set flag.
				posY = 0;
				flag = 1;
			  }
			  if(!flag)
			  {
				resetChar();
			  }
			}
			if(battle)
			{
				//alert(gooAttack);
				//Battle animation
				combatUnits = combatUnits - 5;
				gooPosX = gooPosX + 40;
				gooPosY = gooPosY - 5;
				if(combatUnits == 0)
				{
					opponentHealth-=gooAttackDamage();
					if(opponentHealth <= 0)
					{
						opponentHealth = 0;
					}
					//alert('walla');
					if(opponentTimeout)
					{
						clearTimeout(opponentTimeout);
					}
					if(opponentHealth > 0)
					{
						opponentTimeout = setTimeout(opponentAttack(), 5000);
					}
					gooAttack = 0;
					gooPosX = 250;
					gooPosY = 250;
				}
			}
		}
		
		//transitionIntro
		if(caseNumbers == 200)
		{
			if(transitionIntro)
			{
				units = units - 1.5;
				transitionIntroX = transitionIntroX + 64;
				context.clearRect ( 0 , 0 , canvas.width, canvas.height );
				context.drawImage(transitionIntroImage,transitionIntroX,0,1280,720);
				
			}
			if(transitionOutro)
			{
				units = units - 1.5;
				transitionOutroX = transitionOutroX + 64;
				context.clearRect ( 0 , 0 , canvas.width, canvas.height );
				context.drawImage(transitionOutroImage,transitionOutroX,0,1280,720);
			}
		}
		
		//transitionIntro
		if(caseNumbers == 300)
		{
			if(doOpponentAttack && combatUnits > 0)
			{
				//Opponent battle animation
				combatUnits = combatUnits - 5;
				opponentAttackPosX = opponentAttackPosX - 20;
				opponentAttackPosY = opponentAttackPosY + 5;
				if(!combatUnits)
				{
					doOpponentAttack = 0;
					opponentAttackPosX = 650;
					opponentAttackPosY = 250;
					yourTurn = 1;
					myHealth -= randomIntFromInterval(5,10); 
				}
			}
		}
	}	
	if (flag)
	{
          posX = oldCharX;
          posY = oldCharY;
    }
		
	if((units == 0 || units == 40 || combatUnits == 0) && moving == 1)
	{
		if(units == 0 || combatUnits == 0)
		{
			moving = 0;
			transitionIntro = 0;
			transitionOutro = 0;
		}
		
		
		if((caseNumbers == 37 || caseNumbers == 38 || caseNumbers == 39 || caseNumbers == 40) && roam)
		{
			footstep.pause();
			footstep.currentTime = 0;
			footstep.play();
		}
	}
	
}	  
	  
function draw()
{
if(roam == 1)
{
context.clearRect ( 0 , 0 , canvas.width, canvas.height );
context.drawImage(background,0,0,1280,720);
if(door == 1)
{
	context.drawImage(npc1, npc1PosX, npc1PosY, npc1SizeX, npc1SizeY);
}
if(whiteboardText && locationEvent == 'classroom')
{
	context.font="30px Verdana";
	// Create gradient
	var gradient=context.createLinearGradient(400,0,720,0);
	gradient.addColorStop("0","magenta");
	gradient.addColorStop("0.5","blue");
	gradient.addColorStop("1.0","red");
	// Fill with gradient
	context.fillStyle=gradient;
	context.fillText(whiteboardText,530,70);
}
context.drawImage(npc2, npc2PosX, npc2PosY, npc2SizeX, npc2SizeY);
//context.drawImage(whity, cutPosX, cutPosY, cutWidthX, 300, posX, posY, 70, 105);
if(randomText)
{
	context.font="20px Comic-Sans";
	var textWidth = context.measureText(randomText);
	drawBubble(context, 770,330,textWidth.width+10, 30, 20);	
	// Create gradient
	var gradient=context.createLinearGradient(700,0,800,0);
	gradient.addColorStop("0","green");
	gradient.addColorStop("0.5","green");
	gradient.addColorStop("1.0","green");
	// Fill with gradient
	context.fillStyle=gradient;
	context.fillText(randomText,775,350);
}
context.drawImage(base_image, cutPosX, cutPosY, cutWidthX, 300, posX, posY, 70, 105);
}
if(battle && !transitionIntro)
{
	context.clearRect ( 0 , 0 , canvas.width, canvas.height );
	context.drawImage(background,0,0,1280,720);
	context.drawImage(battleChar1, battleChar1cutPosX, battleChar1cutPosY, cutWidthX, 300, battleChar1PosX, battleChar1PosY, battleChar1SizeX, battleChar1SizeY);
	context.drawImage(battleChar2, 0, 0, cutWidthX, 300, battleChar2PosX, battleChar2PosY, battleChar2SizeX, battleChar2SizeY);
	if(showHealthBars)
	{
		context.fillStyle="#FF0000";
		context.fillRect(battleChar1PosX,battleChar1PosY-50,(myHealth/playerHealth)*200,30);
		context.fillRect(battleChar2PosX,battleChar2PosY-50,(opponentHealth/showHealthBars)*200,30);
	}
	
	if(gooAttack)
	{
		context.drawImage(gooImage, gooPosX, gooPosY, 50, 50);
	}
	
	if(doOpponentAttack)
	{
		context.drawImage(opponentAttackImage, opponentAttackPosX, opponentAttackPosY);
	}
}
}

function startBattle(place,opponent,healthPoints)
{
	transitionIntro = 0;
	transitionIntroX = -1280;
	background.src = place;
	battle = 1;
	yourTurn = 1;
	units = 60;
			
	battleChar1.src = 'sprite.png';
	battleChar1PosX = -200;
	battleChar1PosY = 210;
	battleChar1SizeX = 200;
	battleChar1SizeY = 300;
	battleChar1cutPosX = 1200;
	battleChar1cutWidthX = 200;
	battleChar1cutPosY = 0;
			
	battleChar2.src = opponent;
	battleChar2PosX = 1280;
	battleChar2PosY = 210;
	battleChar2SizeX = 200;
	battleChar2SizeY = 300;
	showHealthBars = healthPoints;
	opponentHealth = healthPoints;
	myHealth = playerHealth;
}

function resetChar()
{
	if(charReset)
	{
		clearTimeout(charReset);
	}
	charReset = setTimeout(function(){cutPosX = 0;	cutWidthX = 200;},700);
}

function alertBox(str)
{
	alert(str);
}

function myCanvas() {
	
}

function switchTrack()
{
	trackNumber++;
	if(trackNumber == 5)
	{
		trackNumber = 1;
	}
	if(battle == 0)
	{
		music.src = "background"+trackNumber+".mp3";
		music.play();
	}
	else {
		music.play();
	}
}

function battleMusic()
{
	var battleTrack = randomIntFromInterval(0,1);
	music.volume = 0.1;
	music.src = "battle"+battleTrack+".mp3";
	music.play();
}

function randomPCMessage()
{
	randomText = randomMessages[randomIntFromInterval(0,randomMessages.length-1)];
	clearTimeout(timeRandomText);
	timeRandomText = setTimeout(function(){randomText = null;}, 2000);
}

function drawBubble(ctx, x, y, w, h, radius)
{
  var r = x + w;
  var b = y + h;
  ctx.beginPath();
  ctx.strokeStyle="black";
  ctx.lineWidth="2";
  ctx.moveTo(x+radius, y);
  ctx.lineTo(r-radius, y);
  ctx.quadraticCurveTo(r, y, r, y+radius);
  ctx.lineTo(r, y+h-radius);
  ctx.quadraticCurveTo(r, b, r-radius, b);
  ctx.lineTo(x+radius, b);
  ctx.lineTo(x+radius/2, y+50);
  ctx.lineTo(x+radius * 2, y+30);
  ctx.quadraticCurveTo(x, b, x, b-radius);
  ctx.lineTo(x, y+radius);
  ctx.quadraticCurveTo(x, y, x+radius, y);
  ctx.stroke();
  ctx.fillStyle="white";
  ctx.fill()
}

function gooAttackMethod()
{
	gooAttack = 1;
}

function gooAttackDamage()
{
	return randomIntFromInterval(7,12);
}

function randomIntFromInterval(min,max)
{
    return Math.floor(Math.random()*(max-min+1)+min);
}

function opponentAttack()
{
	doOpponentAttack = 1;
	caseNumber = 300;
	combatUnits = 80;
}
</script>

</body>
</html>
