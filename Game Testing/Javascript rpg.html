<html>
<head>
<link rel="stylesheet" type="text/css" href="theme.css">
</head>
<body>

<audio id="music" type="audio/mp3" src="background1.mp3" autoplay>
</audio>
<audio id="footstep" type="audio/mp3" src="footstepFloor.mp3">
</audio>
<div style="float:left;">
<canvas id="myCanvas" onclick="myCanvas()" width="1280" height="720"
style="border:1px solid #000000;">
Your browser does not support the HTML5 canvas tag.
</canvas>
<p>
Controls:<br>
Move with arrow keys.<br>
Interact with Ctrl.<br>
Find objects with mouse click.
</p>
</div>
<div style="margin-left:10cm;">
Objectives:<br>
<div id="objective">
Get out of the classroom.<br>
</div><br>
Subjective:<br>
<div id="subjective">
</div>
</div>

<script>
var canvas = document.getElementById('myCanvas'),
context = canvas.getContext('2d');

posX = 800;
posY = 400;
cutPosX = 0;
cutWidthX = 200;
cutPosY = 0;
var charReset;
var door = 0;
var locationEvent = 'classroom';
var moving = 0;
var units = 0;
var caseNumber = 0;
var roam = 1;
var battle = 0;
var transition = 0;
var transitionX = -1280;
var footstep = document.getElementById('footstep');
var music = document.getElementById('music');
var subjective = document.getElementById("subjective");
var objective = document.getElementById("objective");
var moveSidePos = 0;
var movePos = 0;
var trackNumber = 1;
var whiteboardText;




base_image = new Image();
base_image.src = 'sprite.png';

whity = new Image();
whity.src = 'white.png';

background = new Image();
background.src = '../Level Design/ClassRoom.png';

transitionImage = new Image();
transitionImage.src = 'transitionImage.gif';

npc1 = new Image();
var npc1PosX;
var npc1PosY;
var npc1SizeX;
var npc1SizeY;

npc2 = new Image();
var npc2PosX;
var npc2PosY;
var npc2SizeX;
var npc2SizeY;

music.volume = 0.1;

document.addEventListener('keydown', updateMovement);
canvas.addEventListener('mousedown', mouseClick);
music.addEventListener('ended', switchTrack);
//window.addEventListener('load', render);
var FPS = 30;
setInterval(function() {
//function render(){

  update();
  draw();
//  window.requestAnimationFrame(render);
//  }
}, 1000/FPS);

function update()
{
	if(roam == 0 && battle == 0)
	{
		transition = 1;
		if(transitionX == 0)
		{
			transition = 0;
			transitionX = -1280;
			background.src = "battle.jpg";
			battle = 1;
		}
	}
	if(roam == 0 && battle == 1)
	{
		
		//startBattle();
	}
	updateAnimation(caseNumber);
	
}

function mouseClick(event)
{
	canvasX = event.pageX;
	canvasY = event.pageY;
	if(90<canvasX && canvasX < 146 && 10<canvasY && canvasY<110 && locationEvent == 'classroom')
	{
		// Find key in classroom event.
		alertBox('You found the key!'+canvasX+" "+canvasY);
		door = 1;
		npc2.src = '';
		subjective.innerText = "";
	}
}

function updateMovement(evt)
{
	if([37, 38, 39, 40].indexOf(evt.keyCode) > -1) {
        evt.preventDefault();
    }
// Flag to put variables back if we hit an edge of the board.
        var flag = 0;
		var restricted = 0;

        // Get where the char was before key process.
        oldCharX = posX;
        oldCharY = posY;

        switch (evt.keyCode) {

		  // Ctrl
        case 17:
          if (posX == 0 && posY == 300 && locationEvent == 'classroom')
		  {
            // If at door, Fire event
			if(door == 1)
			{
				alertBox('You walked out the door using the key.');
				background.src = '../Level Design/HallWay.png';
				locationEvent = 'hallway';
				posX = 150;
				posY = 120;
				npc1.src = 'cleaning_lady.gif';
				npc1PosX = 590;
				npc1PosY = 300;
				npc1SizeX = 70;
				npc1SizeY = 105;
				subjective.innerText = "Talk to the friendly looking'ish cleaning lady.";
			}
			else
			{
				alertBox('You cant get out. The door is  locked. "HINT: Something sparkles"');
				subjective.innerText = "Find the key.";
				npc2.src = 'sparkles.gif';
				npc2PosX = 175;
				npc2PosY = 100;
				npc2SizeX = 20;
				npc2PosY = 10;
			}
          }

		  if (400 <= posX <= 720 && posY == 40 && locationEvent == 'classroom')
		  {
			whiteboardText = "Teacher is GAY!";
		  }
		  
		  if(posX == 510 && posY == 300 && locationEvent == 'hallway')
		  {
			alertBox('Cleaning lady yells: "U DO CLEAN!, NOT ME!"');
			music.src = 'Battle-of-the-Bits.mp3';
			roam = 0;
			moving = 1;
			units = 30;
			caseNumber = 200;
		  }
          break;
		
          // Left arrow.
        case 37:
		  if(moving == 0)
		  {
		  moving = 1;
		  units = 80;
          caseNumber = 37;
		  
		  
		  }
          break;
		  

          // Right arrow.
        case 39:
		if(locationEvent == 'classroom')
		{
			//Don't go into trash can
		  if(posX+30 == 120 && posY+30 < 80) {
				flag = 1;
				restricted = 1;
			  }
			  }
		  if(moving == 0 && restricted == 0)
		  {
			moving = 1;
			units = 80;
			caseNumber = 39;
		  }
          break;

          // Down arrow
        case 40:
		  if(moving == 0)
		  {
			moving = 1;
			units = 80;
			caseNumber = 40;
		  }
          break;

          // Up arrow 
        case 38:
		if(locationEvent == 'classroom')
		{
		  if(posY-40 < 40) {
				flag = 1;
				restricted = 1;
			  }
			  }
		if(moving == 0 && restricted == 0)
		  {
			moving = 1;
			units = 80;
			caseNumber = 38;
		  }
          break;

        }

        // If flag is set, the ship did not move.
        // Put everything back the way it was.
        
		
		
      }

function updateAnimation(caseNumbers)
{
	var flag = 0;
	if(units == 80)
	{
		oldCharX = posX;
        oldCharY = posY;
	}
	
	if(units > 0)
	{
		//Left arrow
		if(caseNumbers == 37)
		{
			if(roam == 1)
			{
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(moveSidePos == 0){cutPosX = 2200;}
				if(moveSidePos == 1){cutPosX = 2400;}
				if(moveSidePos == 2){cutPosX = 2600;}
				if(moveSidePos == 3){cutPosX = 2400;}
				moveSidePos++;
				if(moveSidePos == 4)
				{moveSidePos = 0;}
				}
				units = units - 5;
				posX = posX - 5;
				
				if (posX < 0)
				{
					// If at edge, reset char position and set flag.
					posX = 0;
					flag = 1;
				}
				if(!(flag))
				{
				resetChar();
				}
			}
		}
		
		// Right arrow
		if(caseNumbers == 39)
		{
			if(roam == 1)
			{
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(moveSidePos == 0){cutPosX = 1400;}
				if(moveSidePos == 1){cutPosX = 1600;}
				if(moveSidePos == 2){cutPosX = 1800;}
				if(moveSidePos == 3){cutPosX = 1600;}
				moveSidePos++;
				if(moveSidePos == 4)
				{moveSidePos = 0;}
				}
				units = units - 5;
				posX = posX + 5;
				
				  if (posX > 1210) {
					// If at edge, reset char position and set flag.
					posX = 1170;
					flag = 1;
				  }
				  if(!(flag))
			  {
				resetChar();
			  }
			}  
		}
		
		//Down arrow
		if(caseNumbers == 40)
		{
			if(roam == 1)
			{
				units = units - 5;
				posY = posY + 2.5;
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(movePos == 0){cutPosX = 200;}
				if(movePos == 1){cutPosX = 400;}
				movePos++;
				if(movePos == 2)
				{movePos = 0;}
				}
			  if (posY > 615) {
				// If at edge, reset ship position and set flag.
				posY = 600;
				flag = 1;
			  }
			  if(!(flag))
			  {
				resetChar();
			  }
			}
		}
		
		//Up arrow
		if(caseNumbers == 38)
		{
			if(roam == 1)
			{
				units = units - 5;
				posY = posY - 2.5;
				if(units == 20 || units == 40 || units == 60 || units == 80)
				{
				if(movePos == 0){cutPosX = 800;}
				if(movePos == 1){cutPosX = 1000;}
				movePos++;
				if(movePos == 2)
				{movePos = 0;}
				}
			  if (posY < 0) {
				// If at edge, reset ship position and set flag.
				posY = 0;
				flag = 1;
			  }
			  if(!(flag))
			  {
				resetChar();
			  }
			}
		}
		
		//transition
		if(caseNumbers == 200)
		{
			if(transition == 1)
			{
				units = units - 1.5;
				transitionX = transitionX + 64;
				context.clearRect ( 0 , 0 , canvas.width, canvas.height );
				context.drawImage(transitionImage,transitionX,0,1280,720);
				
			}
		}
	}	
	if (flag)
	{
          posX = oldCharX;
          posY = oldCharY;
    }
		
	if((units == 0 || units == 40) && moving == 1)
	{
		if(units == 0)
		{
			moving = 0;
			transition = 0;
		}
		
		
		if(caseNumbers == 37 || caseNumbers == 38 || caseNumbers == 39 || caseNumbers == 40)
		{
			footstep.pause();
			footstep.currentTime = 0;
			footstep.play();
		}
	}
	
}	  
	  
function draw()
{
if(roam == 1)
{
context.clearRect ( 0 , 0 , canvas.width, canvas.height );
context.drawImage(background,0,0,1280,720);
if(door == 1)
{
	context.drawImage(npc1, npc1PosX, npc1PosY, npc1SizeX, npc1SizeY);
}
if(whiteboardText)
{
	context.font="30px Verdana";
	// Create gradient
	var gradient=context.createLinearGradient(0,0,canvas.width,0);
	gradient.addColorStop("0","magenta");
	gradient.addColorStop("0.5","blue");
	gradient.addColorStop("1.0","red");
	// Fill with gradient
	context.fillStyle=gradient;
	context.fillText(whiteboardText,500,100);
}
context.drawImage(npc2, npc2PosX, npc2PosY, npc2SizeX, npc2SizeY);
//context.drawImage(whity, cutPosX, cutPosY, cutWidthX, 300, posX, posY, 70, 105);
context.drawImage(base_image, cutPosX, cutPosY, cutWidthX, 300, posX, posY, 70, 105);
}
if(battle == 1 && transition == 0)
{
	context.clearRect ( 0 , 0 , canvas.width, canvas.height );
	context.drawImage(background,0,0,1280,720);
}
}

function resetChar()
{
	if(charReset)
	{
		clearTimeout(charReset);
	}
	charReset = setTimeout(function(){cutPosX = 0;	cutWidthX = 200;},700);
}

function alertBox(str)
{
	alert(str);
}

function myCanvas() {
	
}

function switchTrack()
{
	trackNumber++;
	if(trackNumber == 5)
	{
		trackNumber = 1;
	}
	if(battle == 0)
	{
		music.src = "background"+trackNumber+".mp3";
		music.play();
	}
	else {
		music.play();
	}
}
</script>

</body>
</html>
